<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chat HTML</title>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <link rel="icon" type="image/ico" href="favicon.ico" />

    <link href="css/stylesheets.css" rel="stylesheet" type="text/css" />

    <script type='text/javascript' src='js/plugins/jquery/jquery.min.js'></script>
    <script type='text/javascript' src='js/plugins/jquery/jquery-ui.min.js'></script>
    <script type='text/javascript' src='js/plugins/jquery/jquery-migrate.min.js'></script>
    <script type='text/javascript' src='js/plugins/jquery/globalize.js'></script>
    <script type='text/javascript' src='js/plugins/bootstrap/bootstrap.min.js'></script>

    <script type='text/javascript' src='js/plugins/mcustomscrollbar/jquery.mCustomScrollbar.min.js'></script>
    <script type='text/javascript' src='js/plugins/uniform/jquery.uniform.min.js'></script>

    <script type='text/javascript' src='js/plugins/knob/jquery.knob.js'></script>
    <script type='text/javascript' src='js/plugins/sparkline/jquery.sparkline.min.js'></script>
    <script type='text/javascript' src='js/plugins/flot/jquery.flot.js'></script>
    <script type='text/javascript' src='js/plugins/flot/jquery.flot.resize.js'></script>

    <script type='text/javascript' src='js/plugins.js'></script>
    <script type='text/javascript' src='js/actions.js'></script>
    <script type='text/javascript' src='js/charts.js'></script>
    <script type='text/javascript' src='js/settings.js'></script>
    <script type='text/javascript' src='js/require.js'></script>

    <style>
        .scroll
        {
            overflow-y:scroll;
        }
    </style>
</head>
<body class="bg-img-num1">

    <div class="container">
        <div class="row">
            <div class="col-md-12">

                <div id="main_chat" class="block block-drop-shadow">
                    <div class="header">
                        <h2 id="status">Hello</h2>
                        <div class="side pull-right">
                            <ul class="buttons">
                                <li><a href="#"><span class="icon-user"></span></a></li>
                                <li><a href="#"><span class="icon-cogs"></span></a></li>
                            </ul>
                        </div>
                    </div>
                    <table>
                        <tr>
                            <td style="width: 300px;">
                                <div id="friend_list" class="content" style="overflow-y: auto;">
                                    <h3 style="font-size: medium">Friend list </h3>
                                    <!--<button class="btn" style="width: 200px; text-align: left" id="user_1">
                                        <span class="icon-user"></span>Khanh <span class="icon-comment"></span><br />
                                    </button>
                                    <br />
                                    <button class="btn" style="width: 200px; text-align: left" id="user_2">
                                        <span class="icon-user"></span>Son <span class="icon-comment"></span> <br />
                                    </button>
                                    <br />-->
                                </div>
                                <div class="content">
                                    <button id="btn_user_add" class="btn" style="width: 35px; text-align: center">
                                        <span class="icon-plus"></span>
                                    </button>
                                    <div id="add_user_box" style="float: right">
                                        <input id="txt_user_name" type="text" class="form-control" placeholder="User's name" style="width: 160px" />
                                        <button id="btn_user_ok" class="btn" style="width: 30px; float: right"><span class="icon-check"></span></button>
                                    </div>
                                </div>
                                <div id="group_list" class="content" style="overflow-y: auto;">
                                    <h3 style="font-size: medium">Groups</h3>
                                    <!--<button class="btn" style="width: 200px; text-align: left" id="user_d">
                                        <span class="icon-group"></span> Group 1 <span class="icon-comment"></span>
                                        <br />
                                    </button>
                                    <br />-->
                                </div>
                                <div class="content" id="invite_block">
                                    <button id="btn_invite_add" class="btn" style="width: 60px; text-align: center">
                                        Invite
                                    </button>
                                    <div id="invite_group_box" style="float: right">
                                        <input id="txt_invite_name" type="text" class="form-control" placeholder="Friend's name" style="width: 130px" />
                                        <button id="btn_invite_ok" class="btn" style="width: 30px; float: right"><span class="icon-check"></span></button>
                                    </div>
                                </div>
                                <div class="content">
                                    <button id="btn_group_add" class="btn" style="width: 35px; text-align: center">
                                        <span class="icon-plus"></span>
                                    </button>
                                    <div id="create_group_box" style="float: right">
                                        <input id="txt_group_name" type="text" class="form-control" placeholder="Group's name" style="width: 160px" />
                                        <button id="btn_group_ok" class="btn" style="width: 30px; float: right"><span class="icon-check"></span></button>
                                    </div>
                                </div>
                                <div id="room_list" class="content" style="overflow-y: auto;">
                                    <h3 style="font-size: medium">Chat Rooms</h3>
                                    <!--<button class="btn" style="width: 200px; text-align: left" id="user_c">
                                        <span class="icon-group"></span> Room 1 <span class="icon-comment"></span>
                                        <br />
                                    </button>
                                    <br />-->
                                </div>
                                <div class="content">
                                    <button id="btn_room_add" class="btn" style="width: 35px; text-align: center">
                                        <span class="icon-plus"></span>
                                    </button>
                                    <div id="create_room_box" style="float: right">
                                        <input id="txt_room_name" type="text" class="form-control" placeholder="Room's name" style="width: 160px" />
                                        <button id="btn_room_ok" class="btn" style="width: 30px; float: right"><span class="icon-check"></span></button>
                                    </div>
                                </div>
                                <!--<div class="content">
                                    <input id="txt_test" type="text" class="form-control" placeholder="Test here" style="width: 200px" />
                                    <button id="btn_test" class="btn">Send Test</button>
                                    <input id="txt_status" type="text" class="form-control" placeholder="Test here" style="width: 200px" />
                                </div>-->
                            </td>
                            <td style="width: 85%;">
                                <section id="chat_tab">
                                    <div class="content messages npr npb npt" style="height:450px; overflow-y:hidden">
                                        <div id="inbox" style="height:450px; overflow-y:auto">
                                            
                                        </div>
                                    </div>
                                    <div class="col-md-7">
                                        <div class="input-group">
                                            <span class="input-group-addon"><i class="icon-comment"></i></span>
                                            <input id='messageText' type="text" class="form-control" placeholder="Message here...">
                                            <span class="input-group-btn">
                                                <button id="btn_send_mes" class="btn"><span class="icon-chevron-up"></span></button>
                                            </span>
                                        </div>
                                    </div>
                                </section>
                            </td>

                        </tr>
                    </table>

                </div>
                <div id="login" class="content">
                    <input id="user_login" type="text" class="form-control" placeholder="Type your name" style="width: 400px" />
                    <input id="user_password" type="password" class="form-control" placeholder="Type your password" style="width: 400px" />
                    <button id="btn_login" class="btn">Login</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script type="text/javascript">

    $("#btn_test").click(function () {
        doSend($("#txt_test").val());
    })

    //$(document).ready(function () {
    //    $("#messageText").focus();
    //});

    $(document).keypress(function (e) {
        if (e.which == 13) {
            sendMess();
        }
    });

    $("#btn_send_mes").click(function () {
        sendMess();
    });

    $("#main_chat").hide();
    $("#chat_tab").hide();
    $("#invite_block").hide();
    $("#btn_login").click(btn_login_click);

    var blankChat = '';
    var fName = new Array;
    var nFriend = 0;
    var fHtml = new Array;
    var fType = new Array;
    var current_user = 0;

    //fName[1] = "Khanh";
    //fName[2] = "Son";
    //fHtml[1] = blankChat;
    //fHtml[2] = blankChat;

    $('#friend_list>.btn').click(function (e) {
        var c_user = new Array;
        c_user = this.id.toString().split('_');
        current_user = c_user[1];

        //disableNotification(fName[current_user]);
        $('#inbox').html(fHtml[current_user]);
        $("#chat_tab").show();
    });

    function sendMess() {
        var mes = $('#messageText').val();
        $('#messageText').val('');
        if (mes != '') {
            if (fType[current_user] == 'friend')
                doSend('mess_' + $('#user_login').val() + '_' + fName[current_user] + '_' + mes);
            else if (fType[current_user] == 'room') {
                doSend('room_mess_' + fName[current_user] + '_' + $('#user_login').val() + '_' + mes);
            }
            else {
                doSend('group_mess_' + fName[current_user] + '_' + $('#user_login').val() + '_' + mes);
            }
        }
    }

    function sendMess1(mes) {
        doSend(mes);
    }

    function addMess(msg) {
        //var mes = $('#messageText').val();
        //$('#messageText').val('');
        var html = $('#inbox').html();
        html += '<div class="messages-item.inbox">' +
                                '<img src="img/example/user/dmitry_s.jpg" class="img-circle img-thumbnail"/>' +
                                '<div class="messages-item-text">' + mes + '</div>' +
                                '<div class="messages-item-date">' + new Date() + '</div>' +
                            '</div>';
        $('#inbox').html(html);

        $('#messageText').focus();
    };

    function addMyMess(mes, ImageName)
    {
        var html = $('#inbox').html();
        html += '<div class="messages-item">' +
                                '<img src="img/example/user/dmitry_s_'+ ImageName +'.jpg" class="img-circle img-thumbnail"/>' +
                                '<div class="messages-item-text">' + mes + '</div>' +
                                '<div class="messages-item-date">' + new Date() + '</div>' +
                            '</div>';
        $('#inbox').html(html);
        $('#messageText').focus();
        fHtml[current_user] = html;

        $('#inbox').scrollTop($('#inbox')[0].scrollHeight);
    };

    function addMess1(mes) {
        var html = $('#inbox').html();
        html += '<div class="messages-item">' +
                                '<img src="img/example/user/dmitry_s_Khanh.jpg" class="img-circle img-thumbnail"/>' +
                                '<div class="messages-item-text">' + mes + '</div>' +
                                '<div class="messages-item-date">' + new Date() + '</div>' +
                            '</div>';
        $('#inbox').html(html);
        $('#messageText').focus();
        fHtml[current_user] = html;

        $('#inbox').scrollTop($('#inbox')[0].scrollHeight);
    };

    //friend list, room and group manage functions
    function getiUserByName(name) {
        for (i = 1; i <= nFriend; i++) if (fName[i] == name) return i;
        return 0;
    }

    function friendMess(messArr) {
        if (fName[current_user] == messArr[1]) addMyMess(messArr[1] + ': ' + messArr[2], messArr[1]);
        else {
            var x = getiUserByName(messArr[1]);
            fHtml[x] += '<div class="messages-item">' +
                                '<img src="img/example/user/dmitry_s_'+messArr[1]+'.jpg" class="img-circle img-thumbnail"/>' +
                                '<div class="messages-item-text">' + messArr[1] + ': ' + messArr[2] + '</div>' +
                                '<div class="messages-item-date">' + new Date() + '</div>' +
                            '</div>';
            enableNotification(messArr[1]);
        }
    }

    function addFriend(messArr) {
        var html = $('#friend_list').html();

        nFriend++;
        fHtml[nFriend] = blankChat;
        fName[nFriend] = messArr[1];
        fType[nFriend] = 'friend';

        html += '<button class="btn" style="width: 200px; text-align: left" id="user_' + nFriend + '">'
            + '<span class="icon-user">' + '</span> ' + messArr[1] + ' <span class="icon-comment">' + '</span>' +
            '<br />' + '</button>' + '<br />';

        $('#friend_list').html(html);

        disableNotification(fName[nFriend]);
        disableFriend(fName[nFriend]);

        $('#friend_list>.btn').click(function (e) {
            var c_user = new Array;
            c_user = this.id.toString().split('_');
            current_user = c_user[1];

            disableNotification(fName[current_user]);
            $('#inbox').html(fHtml[current_user]);
            $("#chat_tab").show();
            $("#invite_block").hide();

            $('#inbox').scrollTop($('#inbox')[0].scrollHeight);
        });
    }

    function enableNotification(eName) {
        var i = getiUserByName(eName);
        $('#user_' + i + '>.icon-comment').show();
    }

    function disableNotification(dName) {
        var i = getiUserByName(dName);
        $('#user_' + i + '>.icon-comment').hide();
    }

    function enableFriend(eName) {
        var i = getiUserByName(eName);
        $("#user_" + i).css("color", "white");
    }

    function disableFriend(dName) {
        var i = getiUserByName(dName);
        $("#user_" + i).css("color", "gray");
    }

    $("#add_user_box").toggle();
    $("#btn_user_add").click(function () {
        $("#add_user_box").show();
    })
    $("#btn_user_ok").click(function () {
        var room_name = $("#txt_user_name").val();
        if (room_name != '') {
            sendMess1('addfriend_' + $("#user_login").val() + '_' + room_name);
        }
        $("#add_user_box").hide();
    })

    $("#create_room_box").toggle();
    $("#btn_room_add").click(function () {
        $("#create_room_box").show();
    })
    $("#btn_room_ok").click(function () {
        var room_name = $("#txt_room_name").val();
        if (room_name != '') {
            sendMess1('room_create_' + room_name + '_' + $("#user_login").val());
        }
        $("#create_room_box").hide();
    })

    $("#create_group_box").toggle();
    $("#btn_group_add").click(function () {
        $("#create_group_box").show();
    })
    $("#btn_group_ok").click(function () {
        var group_name = $("#txt_group_name").val();
        if (group_name != '') {
            sendMess1('group_create_' + group_name + '_' + $("#user_login").val());
        }
        $("#create_group_box").hide();
    })

    $("#invite_group_box").toggle();
    $("#btn_invite_add").click(function () {
        $("#invite_group_box").show();
    })
    $("#btn_invite_ok").click(function () {
        var invite_name = $("#txt_invite_name").val();
        if (invite_name != '') {
            sendMess1('group_add_' + fName[current_user] + '_' + invite_name);
        }
        $("#invite_group_box").hide();
    })

    function createRoom(messArr) {
        var html = $('#room_list').html();

        nFriend++;
        fHtml[nFriend] = blankChat;
        fName[nFriend] = messArr[2];
        fType[nFriend] = 'room';

        html += '<button class="btn" style="width: 200px; text-align: left" id="user_' + nFriend + '">'
            + '<span class="icon-group">' + '</span> ' + fName[nFriend] + ' <span class="icon-comment">' + '</span>' +
            '<br />' + '</button>' + '<br />';
        $('#room_list').html(html);

        disableNotification(fName[nFriend]);

        $('#room_list>.btn').click(function (e) {
            var c_user = new Array;
            c_user = this.id.toString().split('_');
            current_user = c_user[1];
            sendMess1('room_join_' + fName[current_user] + '_' + $("#user_login").val());

            disableNotification(fName[current_user]);
            $('#inbox').html(fHtml[current_user]);
            $("#chat_tab").show();
            $("#invite_block").hide();

            $('#inbox').scrollTop($('#inbox')[0].scrollHeight);
        });
    };

    function roomMess(messArr) {
        if (fName[current_user] == messArr[2]) {
            if ($("#user_login").val()==messArr[3])
                addMyMess(messArr[4], messArr[3]);
            else
                addMyMess(messArr[3] + ': ' + messArr[4], messArr[3]);
        }
        else {
            var x = getiUserByName(messArr[2]);
            fHtml[x] += '<div class="messages-item">' +
                                '<img src="img/example/user/dmitry_s.jpg" class="img-circle img-thumbnail"/>' +
                                '<div class="messages-item-text">' + messArr[3] + ': ' + messArr[4] + '</div>' +
                                '<div class="messages-item-date">' + new Date() + '</div>' +
                            '</div>';
            enableNotification(messArr[2]);
        }
    };

    function roomManage(messArr) {
        if (messArr[1] == 'create') createRoom(messArr);
        if (messArr[1] == 'join') addMyMess(messArr[3] + ' has joined', messArr[3]);
        if (messArr[1] == 'mess') roomMess(messArr);
    }

    function createGroup(messArr) {
        show_status('creating group');

        var html = $('#group_list').html();

        nFriend++;
        fHtml[nFriend] = blankChat;
        fName[nFriend] = messArr[2];
        fType[nFriend] = 'group';

        html += '<button class="btn" style="width: 200px; text-align: left" id="user_' + nFriend + '">'
            + '<span class="icon-group">' + '</span> ' + fName[nFriend] + ' <span class="icon-comment">' + '</span>' +
            '<br />' + '</button>' + '<br />';
        $('#group_list').html(html);

        disableNotification(fName[nFriend]);

        $('#group_list>.btn').click(function (e) {
            var c_user = new Array;
            c_user = this.id.toString().split('_');
            current_user = c_user[1];

            disableNotification(fName[current_user]);
            $('#inbox').html(fHtml[current_user]);
            $("#chat_tab").show();
            $("#invite_block").show();

            $('#inbox').scrollTop($('#inbox')[0].scrollHeight);
        });
    };

    function groupAdd(messArr) {
        if ($("#user_login").val() == messArr[3]) {
            createGroup(messArr);
            //message being added
            var x = getiUserByName(messArr[2]);
            fHtml[x] += '<div class="messages-item">' +
                                '<img src="img/example/user/dmitry_s.jpg" class="img-circle img-thumbnail"/>' +
                                '<div class="messages-item-text">You has added into group ' + messArr[2] + '</div>' +
                                '<div class="messages-item-date">' + new Date() + '</div>' +
                            '</div>';
        }
        else {
            //message another has been added
            var x = getiUserByName(messArr[2]);
            fHtml[x] += '<div class="messages-item">' +
                                '<img src="img/example/user/dmitry_s.jpg" class="img-circle img-thumbnail"/>' +
                                '<div class="messages-item-text">' + messArr[3] + ' has been added</div>' +
                                '<div class="messages-item-date">' + new Date() + '</div>' +
                            '</div>';
        }
    }

    function groupMess(messArr) {
        if (fName[current_user] == messArr[2]) {
            if ($("#user_login").val() == messArr[3])
                addMyMess(messArr[4], messArr[3]);
            else
                addMyMess(messArr[3] + ': ' + messArr[4], messArr[3]);
        }
        else {
            var x = getiUserByName(messArr[2]);
            fHtml[x] += '<div class="messages-item">' +
                                '<img src="img/example/user/dmitry_s.jpg" class="img-circle img-thumbnail"/>' +
                                '<div class="messages-item-text">' + messArr[3] + ': ' + messArr[4] + '</div>' +
                                '<div class="messages-item-date">' + new Date() + '</div>' +
                            '</div>';
            enableNotification(messArr[2]);
        }
    };

    function groupManage(messArr) {
        show_status("managing group");
        if (messArr[1] == 'create') createGroup(messArr);
        if (messArr[1] == 'add') groupAdd(messArr);
        if (messArr[1] == 'mess') groupMess(messArr);
    }

    window.addEventListener("load", init, false);

    //websocket functions
    var wsUri = "ws://localhost:8721/";
    var output;
    var players;
    var p_status = document.getElementById("p_status");
    var errors = [];
    var messages = [];
    var name;

    function init() {
        testWebSocket();
    }

    function testWebSocket() {
        websocket = new WebSocket(wsUri);
        websocket.binaryType = 'arraybuffer';

        websocket.onopen = function (evt) {
            onOpen(evt)
        };

        websocket.onclose = function (evt) {
            onClose(evt)
        };

        websocket.onmessage = function (evt) {
            onMessage(evt)
        };

        websocket.onerror = function (evt) {
            onError(evt)
        };
    }

    function send(evt) {
        var text = document.getElementById("txt_Input").value;
        doSend(text);
    }

    function onOpen(evt) {
        //addMess1("Connected");
    }

    function onClose(evt) {
        //addMes1("DISCONNECTED");
    }

    function onMessage(evt) {
        if (typeof (evt.data) == "string") {

            //Show recieved data (for Test)
            //addMess1(evt.data.toString());
            show_status(evt.data.toString());

            var rMess = evt.data.toString();
            var messArr = new Array;
            messArr = rMess.split('_')

            if (messArr[0] == "sent") addMyMess(messArr[2], $("#user_login").val());
            if (messArr[0] == "mess") friendMess(messArr);
            if (messArr[0] == "friend") addFriend(messArr);
            if (messArr[0] == "online") enableFriend(messArr[1]);
            if (messArr[0] == "offline") disableFriend(messArr[1]);
            if (messArr[0] == "room") roomManage(messArr);
            if (messArr[0] == "group") groupManage(messArr);

            if (messArr[0] == "loginOK") loginOk();
            if (messArr[0] == "loginFail") loginFail();
        }
        else if (evt.data instanceof Blob) {
            evt.binaryType = "Blob";
            console.log(evt);
        }
        else if (evt.data instanceof ArrayBuffer) {
            evt.binaryType = "ArrayBuffer";
            console.log(evt);
        }
        messages[messages.length] = evt;
    }

    function onError(evt) {
        addMess1('<span style="color: red;">ERROR:</span> ' + evt + ": " + evt.data);
    }

    function doSend(message) {
        websocket.send(message);
    }

    //button functions
    function btn_login_click() {
        doSend('login_' + $("#user_login").val() + '_' + $("#user_password").val());
    }

    function loginOk() {
        var greeting = "Hi, " + $("#user_login").val();
        $('#status').text(greeting);
        $("#login").hide();
        $("#main_chat").show();
    }

    function loginFail() {
        window.alert("Wrong Password");
    }

    function btn_User_Click() {
        var c_user = new Array;
        c_user = this.id.toString().split('_');
        current_user = c_user[1];

        disableNotification(fName[current_user]);
        $('#inbox').html(fHtml[current_user]);
        $("#chat_tab").show();
    }
    function show_status(msg) {
        $("#txt_status").val(msg);
    }
</script>
